(function () {function z(e,t){var a=(t=t||{}).debug,r=e.width,$=e.height,n=e.getContext("2d"),g=n.getImageData(0,0,r,$),i=n.createImageData(r,$);b([[0,-1,0],[-1,4,-1],[0,-1,0]]).width(r).height($).apply(g,i),a&&(e.width*=2,n.putImageData(i,0,0));var o=A(i.data,r,$);return a&&(q(o,n),n.translate(r,0),n.putImageData(g,r,0),q(o,n)),w(o).midpoint()}function q(e,t){for(var a=0;a<e.length;++a)e[a].draw(t);w(e).drawFocus(t)}function w(e){for(var t,a=e[0],r=1;r<e.length;++r)(t=e[r]).intensity>a.intensity&&(a=t);return a}function A(e,t,a){var r=[],$=t/2,n=a/2;function g(e,t){return e=Math.abs(e-$)/$,t=Math.abs(t-n)/n,1-((e/=2)+(t/=2))}for(var i=0;i<t;++i){for(var o=0;o<a;++o){for(var u=.15*g(i+10,o+10),M=Math.min(t-i,20),m=Math.min(a-o,20),s=0,v=0;v<M;++v)for(var f=0;f<m;++f){var k=4*((o+f)*t+(i+v));s+=(e[k+0]+e[k+1]+e[k+2])/765}u+=s/400*.85,r.push(new j(i,o,M,m,5*u)),o+=20}i+=20}return r}function b(t){if(!(this instanceof b))return new b(t);if(!t)throw new TypeError("convolution matrix required");this.matrix=t,this.factor(1),this.bias(0)}b.prototype.width=function(t){return this.w=t,this},b.prototype.height=function(t){return this.h=t,this},b.prototype.factor=function(t){return this._factor=t,this},b.prototype.bias=function(t){return this._bias=t,this},b.prototype.apply=function(t,r){for(var e=t.data,a=r.data,o=this.w,i=this.h,h=this.matrix,$=h[0].length,f=h.length,p=Math.floor(f/2),n=this._factor,s=this._bias,u=0;u<i-1;u++)for(var d=0;d<o-1;d++){for(var l=4*(u*o+d),x=0,c=0,E=0,J=0;J<$;++J)for(var N=0;N<f;++N){var X=4*((u+(J-p))*o+(d+(N-p)));x+=e[X+0]*h[J][N],c+=e[X+1]*h[J][N],E+=e[X+2]*h[J][N]}a[l+0]=n*x+s,a[l+1]=n*c+s,a[l+2]=n*E+s,a[l+3]=e[l+3]}},b.prototype.canvas=function(t){var r=t.width,e=t.height,a=t.getContext("2d"),o=a.getImageData(0,0,r,e),i=a.createImageData(r,e);this.width(r),this.height(e),this.apply(o,i),a.putImageData(i,0,0)};function j(t,i,e,s,h){this.x=t,this.y=i,this.w=e,this.h=s,this.intensity=h||0}function y(t,$){this.x=t,this.y=$}y.prototype.toString=function(){return"("+this.x+", "+this.y+")"};j.prototype.midpoint=function(){return new y(this.x+this.w/2,this.y+this.h/2)},j.prototype.draw=function(t){var i=255*this.intensity|0,e=this.w/2*this.intensity;t.save(),t.beginPath(),t.fillStyle="rgba("+i+",0,0, .5)",t.arc(this.x+this.w/2,this.y+this.h/2,e,0,2*Math.PI,!1),t.fill(),t.restore()},j.prototype.drawFocus=function(t){var i=255*this.intensity|0,e=this.w/2*this.intensity;t.save(),t.beginPath(),t.fillStyle="rgba(0,0,"+i+", .5)",t.arc(this.x+this.w/2,this.y+this.h/2,e,0,2*Math.PI,!1),t.fill(),t.restore()};var B=function(e){var n=e.options.components["k-files-section"];e.component("k-files-section",{extends:n,data:function(){return{firstLoad:!0}},watch:{data:{immediate:!1,handler:function(e,n){if(this.isLoading)return!1;if(!n.length&&this.firstLoad)return this.firstLoad=!1,!1;var t=e.filter(function(e,t){return!n.filter(function(n,t){return n.filename==e.filename}).length});if(!t.length)return!1;FileReader&&this.findFocus(t)}}},methods:{findFocus:function(e){var n=this;e.forEach(function(e){var t=n,o=new XMLHttpRequest;o.open("get",e.url),o.responseType="blob",o.onload=function(){var n=new FileReader;n.onload=function(){var o=document.createElement("canvas"),i=o.getContext("2d"),a=new Image;a.onload=function(){var n=a.width,r=a.height;o.width=n,o.height=r,i.drawImage(a,0,0);var s=z(o,{debug:!1}),u=s.x/n,c=s.y/r,f="{\"x\":"+(u=(Math.round(100*u)/100).toFixed(2))+",\"y\":"+(c=(Math.round(100*c)/100).toFixed(2))+"}";t.saveFocus(e,f)},a.src=n.result},n.readAsDataURL(o.response)},o.send()})},saveFocus:function(e,n){this.$api.post("autofocus/save-focus",{uri:e.parent,filename:e.filename,coords:n}).then(function(e){}).catch(function(e){console.log(e)})}}})};panel.plugin("sylvainjule/autofocus",{use:[B]});})();